name: UIA Bench (OpenAI)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: write

concurrency:
  group: uia-bench
  cancel-in-progress: true

jobs:
  uia:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci || npm i

      - name: Run UIA (concurrent)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p results
          TS=$(date -u +"%Y-%m-%dT%H%M%SZ")
          echo "TS=$TS" >> $GITHUB_ENV
          node index.js \
            --A=all \
            --prompts=6 \
            --concurrency=6 \
            --model=gpt-4o-mini \
            --max_tokens=120 \
            --log="results/uia_${TS}.jsonl"
          echo "UIA log: results/uia_${TS}.jsonl"

      - uses: actions/upload-artifact@v4
        with:
          name: uia-results
          path: results/uia_*.jsonl
          if-no-files-found: warn

      - name: Generate summary
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const glob = (pat) => fs.readdirSync('results').filter(f => f.match(pat)).map(f => 'results/'+f);
          const pickLatest = (files) => files.sort().slice(-1)[0];
          const uiaFile = pickLatest(glob(/^uia_.*\.jsonl$/));
          
          function rows(p) {
            if (!p || !fs.existsSync(p)) return [];
            return fs.readFileSync(p,'utf8').trim().split('\n').filter(Boolean).map(l=>{try{return JSON.parse(l)}catch{return null}}).filter(Boolean);
          }
          
          const uia = rows(uiaFile).filter(r => (r.event||"").includes("BENCH:row"));
          
          function agg(rows) {
            const by = {};
            for (const r of rows) {
              const A = r.targetA || 'NA';
              by[A] ??= { n:0, lat:0 };
              by[A].n++;
              by[A].lat += Number(r.latencyMs) || 0;
            }
            return Object.fromEntries(Object.entries(by).map(([k,v]) => [k, {count:v.n, avgLatencyMs: v.n? Math.round(v.lat/v.n):0}]));
          }
          
          const stats = agg(uia);
          const ts = (uiaFile||'').match(/\d{8}T\d{6}Z/)?.[0] || 'N/A';
          
          let md = `# UIA Bench â€” ${ts}\n\n`;
          md += `File: \`${uiaFile||'n/a'}\`\n\n`;
          md += `| Attack Category | Count | Avg Latency (ms) |\n`;
          md += `|-----------------|------:|-----------------:|\n`;
          for (const [k, v] of Object.entries(stats).sort()) {
            md += `| ${k} | ${v.count} | ${v.avgLatencyMs} |\n`;
          }
          fs.writeFileSync('results/summary.md', md, 'utf8');
          console.log(md);
          NODE

      - uses: actions/upload-artifact@v4
        with:
          name: all-results
          path: results/**
          if-no-files-found: warn