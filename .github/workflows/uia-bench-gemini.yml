# Votre fichier uia-bench-gemini.yml (l√©g√®rement ajust√©)

name: UIA Bench (Gemini)

on:
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Concurrency level (1 or 2 recommended for stability)'
        required: false
        default: '1'
      gemini_version:
        description: 'Gemini model (e.g., gemini-2.5-flash, gemini-2.5-pro, gemini-2.5-pro-vision)'
        required: false
        default: 'gemini-2.5-flash'

permissions:
  contents: write

concurrency:
  group: uia-bench-gemini-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies (Strict & Reproducible)
        run: |
          set -e
          # Utiliser 'npm ci' pour une installation propre bas√©e sur package-lock.json.
          npm ci
          
          # üö® AJOUT CRITIQUE: Installer le SDK Google pour Gemini
          npm install @google/generative-ai
          
          # V√©rification de l'installation
          npm list @google/generative-ai
          echo "‚úì Dependencies installed successfully"

      - name: Validate Setup and Environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          
          echo "üîç Environment Validation"
          echo "=========================="
          
          # Verify Node version
          echo "‚úì Node version: $(node --version)"
          echo "‚úì NPM version: $(npm --version)"
          
          # Verify Google Generative AI SDK
          if ! npm list @google/generative-ai > /dev/null 2>&1; then
            echo "‚ùå Google Generative AI SDK (@google/generative-ai) not installed properly"
            npm list @google/generative-ai
            exit 1
          fi
          echo "‚úì Google Generative AI SDK @google/generative-ai installed"
          
          # Verify API key
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "‚ùå GEMINI_API_KEY secret is not set"
            echo "   Configure in: GitHub Settings > Secrets and variables > Actions > GEMINI_API_KEY"
            exit 1
          fi
          echo "‚úì GEMINI_API_KEY is set"
          
          # Verify index.js exists
          if [ ! -f "index.js" ]; then
            echo "‚ùå index.js not found in repository root"
            exit 1
          fi
          echo "‚úì index.js found"
          
          # Check if Gemini provider is implemented (This should now pass with the new index.js)
          if ! grep -q "PROVIDER: gemini" index.js; then
            echo "‚ö†Ô∏è  WARNING: PROVIDER: gemini not found in index.js"
            echo "   Make sure callLLM_Gemini() is integrated into callLLM() function"
            echo "   Workflow will still attempt to run..."
          fi
          
          echo ""
          echo "‚úì All environment checks passed"

      - name: Run UIA Bench (Gemini) with Retry Logic
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PROVIDER: gemini
          NODE_OPTIONS: --max-old-space-size=4096
          LOG_LEVEL: debug
        run: |
          set -euo pipefail
          
          mkdir -p results
          TS=$(date -u +"%Y-%m-%dT%H%M%SZ")
          # üí° Remplacez uia_gemini par le nom du mod√®le pour une meilleure organisation
          MODEL_SLUG=$(echo "${{ github.event.inputs.gemini_version || 'gemini-2.5-flash' }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')
          LOG="results/uia_${MODEL_SLUG}_${TS}.jsonl"
          
          ATTEMPT=0
          MAX_ATTEMPTS=3
          CONCURRENCY="${{ github.event.inputs.concurrency || '1' }}"
          MODEL="${{ github.event.inputs.gemini_version || 'gemini-2.5-flash' }}"
          
          echo ""
          echo "üöÄ Starting UIA Bench (Gemini)"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Model:       ${MODEL}"
          echo "Concurrency: ${CONCURRENCY} (low for stability)"
          echo "Max retries: ${MAX_ATTEMPTS}"
          echo "Log file:    ${LOG}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Utilisation de 'node index.js' et non 'node .' pour √™tre explicite
            if node index.js \
              --A=all --prompts=all --concurrency="${CONCURRENCY}" \
              --model="${MODEL}" --t=0.2 --max_tokens=180 \
              --metrics=true --diag=true --log="${LOG}"; then
              
              echo ""
              echo "‚úì Run completed successfully on attempt ${ATTEMPT}"
              break
              
            else
              EXIT_CODE=$?
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo ""
                echo "‚ö†Ô∏è Attempt ${ATTEMPT} failed (exit code: ${EXIT_CODE})"
                echo "Waiting 60 seconds before retry..."
                sleep 60
              else
                echo ""
                echo "‚ùå All ${MAX_ATTEMPTS} attempts failed"
                exit $EXIT_CODE
              fi
            fi
          done
          
          echo "LOG_PATH=${LOG}" >> "$GITHUB_ENV"

      # Le reste du fichier YAML est conserv√© sans changement pour les √©tapes de validation et d'upload.
      # ... (steps: Validate Run Quality, Upload results, Create Detailed Summary, Notify on Validation Failure)